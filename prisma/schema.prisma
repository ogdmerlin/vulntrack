generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Team {
  id        String   @id @default(uuid())
  name      String
  users     User[]
  vulnerabilities Vulnerability[]
  invitations Invitation[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String?   @unique
  password      String?
  image         String?
  role          String    @default("VIEWER") // ADMIN, ANALYST, VIEWER
  status        String    @default("ACTIVE") // ACTIVE, INACTIVE, PENDING
  isOnboarded   Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id])
  
  vulnerabilities Vulnerability[]
  assignedVulnerabilities Vulnerability[] @relation("AssignedVulnerabilities")
  auditLogs     AuditLog[]
  comments      Comment[]
  invitations   Invitation[]  @relation("UserInvitations")
  notifications Notification[]
}

model Vulnerability {
  id          String   @id @default(uuid())
  title       String
  description String
  status      String
  severity    String
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  teamId      String?
  team        Team?    @relation(fields: [teamId], references: [id])
  
  assignedToId String?
  assignedTo   User?    @relation("AssignedVulnerabilities", fields: [assignedToId], references: [id])
  
  approvalStatus String @default("APPROVED") // PENDING, APPROVED, REJECTED
  
  dread       DreadScore?
  stride      StrideScore?
  comments    Comment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // New fields for rich dashboard
  cveId             String?
  cvssScore         Float?
  asset             String?
  affectedSystems   String? // JSON serialized
  mitigations       String? // JSON serialized
  references        String? // JSON serialized
  attackVector      String?
  attackComplexity  String?
  privilegesRequired String?
  impactAssessment  String? // JSON serialized
}

model Comment {
  id              String        @id @default(uuid())
  content         String
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  vulnerabilityId String
  vulnerability   Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  entityType  String
  entityId    String?
  details     String?
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
}

model DreadScore {
  id              String        @id @default(uuid())
  damage          Float
  reproducibility Float
  exploitability  Float
  affectedUsers   Float
  discoverability Float
  total           Float
  
  vulnerabilityId String        @unique
  vulnerability   Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
}

model StrideScore {
  id                    String        @id @default(uuid())
  spoofing              Boolean
  tampering             Boolean
  reputation            Boolean
  informationDisclosure Boolean
  denialOfService       Boolean
  elevationOfPrivilege  Boolean
  
  vulnerabilityId       String        @unique
  vulnerability         Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)
}

model Invitation {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  role      String   @default("VIEWER")
  expiresAt DateTime
  inviterId String
  inviter   User     @relation("UserInvitations", fields: [inviterId], references: [id])
  
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id])
  
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  type      String   // VULNERABILITY_ASSIGNED, STATUS_CHANGED, COMMENT_ADDED, etc.
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?  // Optional link to navigate to
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}
